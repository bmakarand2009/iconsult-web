/*! iconsult 03-02-2014 version: 1.0.0 
 author: https://twitter.com/MakBkar */

var Application = Application || {};

Application.Security = angular.module("iconsult.security", []);

Application.Security.controller("SecurityLoginCtrl", function($scope, securityService, user) {
    $scope.user = user || {};
    $scope.submit = function(successFn) {
        // var postData = { 
        //   "username": $scope.username, 
        //   "password": $scope.password 
        // }
        $scope.resp = securityService.signIn($scope.user);
        //Auth code is alwaysof 15 digits
        $scope.resp.$promise.then(function(data) {
            data.username = $scope.user.username;
            successFn(data);
        });
    };
});

Application.Security.controller("SecurityCtrl", function($scope, securityService) {
    $scope.testUser = {
        username: "testUser",
        password: "abc"
    };
    $scope.loginWithError = function() {
        securityService.registerUser(this.testUser);
    };
    $scope.$on("event:auth-invalidlogin", function() {});
});

/**
* This directive will find itself inside HTML as a class,
* and will remove that class, so CSS will remove loading image and show app content.
* It is also responsible for showing/hiding login form.
*/
Application.Security.directive("securityAuthHandler", function(showDialog, securityDialogs) {
    return {
        restrict: "C",
        link: function(scope, elem, attrs) {
            //once Angular is started, remove class:
            elem.removeClass("waiting-for-angular");
            scope.$on("event:auth-loginRequired", function() {
                // $cookieStore.put('status','Invalid Credentials, Login Again')
                showDialog(securityDialogs.loginDialog(), {
                    user: {}
                });
            });
            scope.$on("event:auth-loginConfirmed", function() {});
        }
    };
});

Application.Security.service("securityDialogs", function($http, $rootScope, authService, $cookieStore, RestMaster, $state) {
    var self = this;
    /*Data
     "access_token":"boQtj0SCGz2GFGz[...]",
    "token_type":"bearer",
    "expires_in":1209599,
    "userName":"Alice",
    ".issued":"Mon, 14 Oct 2013 06:53:32 GMT",
    ".expires":"Mon, 28 Oct 2013 06:53:32 GMT"
    */
    this.loginSuccess = function(data) {
        var myauth;
        alert("login success revcived");
        for (var i = 0; i < 16; i++) {
            if (typeof myauth == "undefined") myauth = data[i]; else myauth = myauth + data[i];
        }
        console.log("authcode is here" + myauth);
        console.log("Storing authcode to cookie");
        RestMaster.updateAuthCode(myauth);
        alert("updated AuthcoDE" + myauth);
        $cookieStore.put("authCode", myauth);
        $cookieStore.put("username", data.username);
        $cookieStore.put("status", "");
        //reload the current state
        console.log("reload is true");
        $state.go("Candidates.list", {
            reload: true
        });
    };
    return {
        loginDialog: function() {
            return {
                name: "Login",
                module: "User",
                templateUrl: "security/security.login.html",
                controller: "SecurityLoginCtrl",
                message: "User successfully logged in",
                successFn: function(data) {
                    self.loginSuccess(data);
                }
            };
        }
    };
});

Application.Security.factory("securityService", [ "$resource", "$http", "appConstants", function($resource, $http, appConstants) {
    return {
        signIn: function(data) {
            return $resource(appConstants.baseUrl + "rest/auth").get(data);
        },
        signOut: function() {
            var username = $cookieStore.get("username");
            var params = {
                username: username
            };
            return $resource(appConstants.baseUrl + "auth/logout").get(params);
        }
    };
} ]);
//# sourceMappingURL=web-app/assets/sources.min.js.map